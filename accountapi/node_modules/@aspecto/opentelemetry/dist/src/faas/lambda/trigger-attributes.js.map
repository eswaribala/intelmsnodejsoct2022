{"version":3,"file":"trigger-attributes.js","sourceRoot":"","sources":["../../../../src/faas/lambda/trigger-attributes.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n    SemanticAttributes,\n    MessagingDestinationKindValues,\n    MessagingOperationValues,\n} from '@opentelemetry/semantic-conventions';\nimport { AspectoAttributeNames, LambdaAttributes } from '@aspecto/opentelemetry-base';\nimport {\n    APIGatewayProxyEventBase,\n    ScheduledEvent,\n    SQSEvent,\n    SNSEvent,\n    APIGatewayProxyEventV2,\n    APIGatewayProxyEventQueryStringParameters,\n} from 'aws-lambda';\nimport { httpHeadersToSpanAttributes } from '../../plugins-customizations/http-headers';\n\nconst getScheduledEventAttributes = (event: ScheduledEvent) => {\n    return {\n        [SemanticAttributes.FAAS_TRIGGER]: 'timer',\n        [SemanticAttributes.FAAS_TIME]: event.time,\n    };\n};\n\nconst queryStringObjectToString = (qso: APIGatewayProxyEventQueryStringParameters) =>\n    typeof qso === 'object' && Object.keys(qso).length > 0\n        ? '?' +\n          Object.entries(qso)\n              .map(([k, v]) => `${k}=${v}`)\n              .join('&')\n        : '';\n\nconst getHttpV1Attributes = (event: APIGatewayProxyEventBase<any>) => {\n    const queryString = queryStringObjectToString(event.queryStringParameters);\n    const lowerCaseHeaders = new Map(Object.entries(event.headers ?? {}).map(([k, v]) => [k.toLowerCase(), v]));\n    const agent = event.requestContext?.identity?.userAgent ?? lowerCaseHeaders.get('user-agent');\n    const scheme = lowerCaseHeaders.get('x-forwarded-proto') ?? 'https';\n    const host = lowerCaseHeaders.get('host') ?? event.requestContext?.domainName;\n    const path = event.requestContext?.path ?? event.path;\n    const route =\n        event.requestContext?.stage && event.resource\n            ? `/${event.requestContext?.stage}${event.resource}`\n            : event.resource;\n\n    return {\n        [SemanticAttributes.FAAS_TRIGGER]: 'http',\n        [SemanticAttributes.HTTP_METHOD]: event.httpMethod,\n        [SemanticAttributes.HTTP_SCHEME]: scheme,\n        [SemanticAttributes.HTTP_HOST]: host,\n        [SemanticAttributes.HTTP_TARGET]: path ? `${path}${queryString}` : undefined,\n        [SemanticAttributes.HTTP_FLAVOR]: event.requestContext?.protocol?.split('/').pop(),\n        [SemanticAttributes.HTTP_USER_AGENT]: agent,\n        [SemanticAttributes.HTTP_ROUTE]: route ?? path,\n        [AspectoAttributeNames.HTTP_REQUEST_BODY]: event.body ? event.body : '',\n        [AspectoAttributeNames.HTTP_PATH]: path,\n        ['http.route.params']: event.pathParameters ? JSON.stringify(event.pathParameters) : undefined,\n        ...httpHeadersToSpanAttributes('request', event.headers),\n    };\n};\n\nconst getHttpV2Attributes = (event: APIGatewayProxyEventV2) => {\n    const queryString = queryStringObjectToString(event.queryStringParameters);\n    const lowerCaseHeaders = new Map(Object.entries(event.headers ?? {}).map(([k, v]) => [k.toLowerCase(), v]));\n    const agent = event.requestContext?.http?.userAgent ?? lowerCaseHeaders.get('user-agent');\n    const scheme = lowerCaseHeaders.get('x-forwarded-proto') ?? 'https';\n    const host = lowerCaseHeaders.get('host') ?? event.requestContext?.domainName;\n    const path = event.requestContext?.http?.path ?? event.rawPath;\n\n    return {\n        [SemanticAttributes.FAAS_TRIGGER]: 'http',\n        [SemanticAttributes.HTTP_METHOD]: event.requestContext.http.method,\n        [SemanticAttributes.HTTP_SCHEME]: scheme,\n        [SemanticAttributes.HTTP_HOST]: host,\n        [SemanticAttributes.HTTP_TARGET]: path ? `${path}${queryString}` : undefined,\n        [SemanticAttributes.HTTP_FLAVOR]: event.requestContext.http.protocol?.split('/').pop(),\n        [SemanticAttributes.HTTP_USER_AGENT]: agent,\n        [SemanticAttributes.HTTP_ROUTE]: path,\n        [AspectoAttributeNames.HTTP_REQUEST_BODY]: event.body ? event.body : '',\n        [AspectoAttributeNames.HTTP_PATH]: path,\n        ['http.route.params']: event.pathParameters ? JSON.stringify(event.pathParameters) : undefined,\n        ...httpHeadersToSpanAttributes('request', event.headers),\n    };\n};\n\nconst getSqsAttributes = (event: SQSEvent) => {\n    const record = event.Records[0];\n    const arnArray = record.eventSourceARN.split(':');\n    const queueName = arnArray.pop();\n    const accountId = arnArray.pop();\n    return {\n        [SemanticAttributes.FAAS_TRIGGER]: 'pubsub',\n        [SemanticAttributes.MESSAGING_OPERATION]: MessagingOperationValues.RECEIVE,\n        [SemanticAttributes.MESSAGING_SYSTEM]: 'aws.sqs',\n        [SemanticAttributes.MESSAGING_DESTINATION_KIND]: MessagingDestinationKindValues.QUEUE,\n        [SemanticAttributes.MESSAGING_DESTINATION]: queueName,\n        [SemanticAttributes.MESSAGING_URL]: `https://sqs.${record.awsRegion}.amazonaws/${accountId}/${queueName}`,\n    };\n};\n\nconst getSnsAttributes = (event: SNSEvent) => {\n    const record = event.Records[0];\n    // TopicArn example: arn:aws:sns:us-east-1:1234567890:my-topic\n    const arnArray = record.Sns.TopicArn.split(':');\n    const topicName = arnArray.pop();\n    return {\n        [SemanticAttributes.FAAS_TRIGGER]: 'pubsub',\n        [SemanticAttributes.MESSAGING_OPERATION]: MessagingOperationValues.RECEIVE,\n        [SemanticAttributes.MESSAGING_SYSTEM]: 'aws.sns',\n        [SemanticAttributes.MESSAGING_DESTINATION_KIND]: MessagingDestinationKindValues.TOPIC,\n        [SemanticAttributes.MESSAGING_DESTINATION]: topicName,\n        // TODO: Split to different traces per message ID\n        [LambdaAttributes.EVENT]: JSON.stringify(event),\n    };\n};\n\nexport const isSqs = (event: any) => (event as SQSEvent)?.Records?.[0]?.eventSource === 'aws:sqs';\nexport const isSns = (event: any) => (event as SNSEvent)?.Records?.[0]?.EventSource === 'aws:sns';\nexport const isTimer = (event: any) => (event as ScheduledEvent)?.['detail-type'] === 'Scheduled Event';\nconst isHttpV1 = (event: any) => (event as APIGatewayProxyEventBase<any>)?.httpMethod;\nconst isHttpV2 = (event: any) => (event as APIGatewayProxyEventV2)?.requestContext?.http;\nexport const isHttp = (event: any) => isHttpV1(event) || isHttpV2(event);\n\nexport const getTriggerSpecificAttributes = (event: any = {}) => {\n    try {\n        if (isHttpV1(event)) return getHttpV1Attributes(event);\n        if (isHttpV2(event)) return getHttpV2Attributes(event);\n        if (isTimer(event)) return getScheduledEventAttributes(event);\n        if (isSqs(event)) return getSqsAttributes(event);\n        if (isSns(event)) return getSnsAttributes(event);\n    } catch {}\n\n    return {\n        [LambdaAttributes.EVENT]: JSON.stringify(event),\n        [SemanticAttributes.FAAS_TRIGGER]: 'other',\n    };\n};\n"]}