{"ast":null,"code":"'use strict';\n\nmodule.exports = exports = semaphore;\n\nfunction semaphore(count) {\n  const resolvers = [];\n  let counter = count;\n  const sem = {\n    take,\n    release,\n    test\n  };\n  Object.defineProperty(sem, 'count', {\n    get: _ => counter,\n    enumerable: true\n  });\n  return sem;\n\n  function take(timeout) {\n    if (counter > 0) {\n      --counter;\n      return Promise.resolve(release);\n    }\n\n    return new Promise((resolve, reject) => {\n      resolvers.push(_ => {\n        --counter;\n        resolve(release);\n      });\n\n      if (timeout) {\n        setTimeout(_ => {\n          resolvers.shift();\n          const err = new Error(`Timed out after ${timeout}ms`);\n          err.code = 'ETIMEDOUT';\n          reject(err);\n        }, timeout);\n      }\n    });\n  }\n\n  function release() {\n    counter++;\n\n    if (resolvers.length > 0) {\n      resolvers.shift()();\n    }\n  }\n\n  function test() {\n    if (counter < 1) return false;\n    return take() && true;\n  }\n}","map":null,"metadata":{},"sourceType":"script"}